---
title: "Hypothesis 2"
description: "(a) The use of population terminology has increased in biomedical abstracts since 1990 and (b) The use of terms like genetic ancestry as well as national and continental terms have outpaced racial and ethnic terms in biomedical literature."
output: html_document
weight: 2
---

While our first set of analyses established that "diversity" is increasing modestly in the biomedical literature, we also wanted to account for how terminology related to population testing has changed over time. [Fujimura and Rajagopalan's (2011)](https://journals.sagepub.com/doi/abs/10.1177/0306312710379170) have suggested that researchers now use biogeographic and genetic ancestry terms more often than race and ethnicity in their studies. Relatedly, [Panofsky and Bliss (2017)](https://journals.sagepub.com/doi/abs/10.1177/0003122416685812?casa_token=ONTaswwjG9kAAAAA:zyJZCoDHuqmsuTVVUncKX8WqRWSDrhU_adG-ZzBawFV_mwVI6JgXNoLfdo0EAfNMuDmePVo8DteOJg) have found that racial and ethnic terms (including those within the US Census and OMB Directive 15 labeling schema) have been replaced by more general biogeographic terms such continental, national, and directional terminology. Below, we test how these sets of terms vary over time using computational text analysis. 

To do this, we [created a dictionary](https://growthofdiversity.netlify.app/analyses/dictionaries) with various sets of terms corresponding to the existing literature. This dictionary includes a comprehensive (though not necessarily exhaustive) list of  around 2,000 continental, subcontinental, national, directional, ancestry, and OMB/US Census terms. Additionally, we compiled a list of roughly 6,500 unique terms of ethnic, tribal, and caste terms that we umbrella under the category of "subnational." In addition to an [interactive tree diagram](https://growthofdiversity.netlify.app/analyses/dictionaries) that visualizes these term sets, we have also included a searchable table to explore which terms are included in each category set. While future work will need to explore how these categories overlap and intertwine, the forthcoming analyses simply demonstrate how these term sets vary over time within the biomedical and diversity samples. 

```{r prereqs h2ab, message = FALSE, results = FALSE, warning=FALSE, echo=FALSE}
rm(list = ls())

for (pkg in c("tidyverse", "igraph", "tidytext", "ggplot2", "DT", "maditr",
              "grid", "gridExtra", "reshape2", "extrafont", "data.table",
              "plotly", "stringi", "networkD3")) {library(pkg, character.only = TRUE)}

setwd("~/Documents/Diversity/Data")
# loading the .csv file 
text_data <- read_csv("biomedical_corpus.csv") %>% 
  rowid_to_column(var = "id") %>% 
  rename(authors = AU, title = TI, publication = SO, #author_keywords = DE,
         abstract = AB, references = CR, year = PY, times_cited = TC, pubmed_id = UT) %>% 
  select(id, authors, title, year, publication, abstract, references, year, times_cited, pubmed_id) %>% 
  drop_na(abstract) %>%
# filtering 2018 articles because they seem to be incomplete 
  filter(year != "2018")

# tokenizing the abstract data into words 
abstract_data <- text_data %>% 
  unnest_tokens(word, abstract) #%>% anti_join(stop_words)
# adding custom set of stopwords 
my_stopwords <- tibble(word = c(as.character(1:14), "[0-9]", 
                                "rights", "reserved", "copyright", "elsevier", 
                                "women.recommendations", 
                                "cs.man.ac.uk", "sexes.please", "movements.baby"))
abstract_data <- abstract_data %>% 
  anti_join(my_stopwords)

# lets draw all of our strings from the diversity_dictionary
setwd("~/Documents/Diversity/Data")
divictionary <- read_csv("diversity_project - h1_dictionary.csv") 

# pulling our list of population
h2_dictionary <- read_csv("diversity_project - h2_dictionary.csv") 
# pulling in concatenated population terms from our dataset 
continental_terms <- h2_dictionary %>% filter(category == "continental")
subcontinental_terms <- h2_dictionary %>% filter(category == "subcontinental")
national_terms <- h2_dictionary %>% filter(category == "national")
subnational_terms <- h2_dictionary %>% filter(category == "subnational")
directional_terms <- h2_dictionary %>% filter(category == "directional")
race_ethnicity <- h2_dictionary %>% filter(category == "race/ethnicity")
omb_uscensus <- h2_dictionary %>% filter(category == "omb/us census")
ancestry <- h2_dictionary %>% filter(category == "ancestry")

# creating detection string patterns for all the categories
all_pop_terms <- paste(c("\\b(?i)(zcx", 
                 h2_dictionary$term, "zxc)\\b"), collapse = "|")
continental_terms <- paste(c("\\b(?i)(zxz", 
                     continental_terms$term, "zxz)\\b"), collapse = "|")
subcontinental_terms <- paste(c("\\b(?i)(zxz", 
                        subcontinental_terms$term, "zxz)\\b"), collapse = "|")
national_terms <- paste(c("\\b(?i)(zxz", 
                  national_terms$term, "zxz)\\b"), collapse = "|")
subnational_terms <- paste(c("\\b(?i)(zxz", 
                     subnational_terms$term, "zxz)\\b"), collapse = "|")
directional_terms <- paste(c("\\b(?i)(zxz", 
                     directional_terms$term, "zxz)\\b"), collapse = "|")
race_ethnicity <- paste(c("\\b(?i)(zxz", 
                  race_ethnicity$term, "zxz)\\b"), collapse = "|")
omb_uscensus <- paste(c("\\b(?i)(zxz", 
                omb_uscensus$term, "zxz)\\b"), collapse = "|")
ancestry <- paste(c("\\b(?i)(zxz", 
            ancestry$term, "zxz)\\b"), collapse = "|")

# graphing the population terms into various categories 
pop_terms_bycats <- abstract_data %>% 
  as.data.table() %>% 
  dt_mutate(all_pop_terms = ifelse(test = str_detect(string = abstract_data$word, 
                         pattern = all_pop_terms), 
                         yes = 1, no = 0)) %>%
  dt_mutate(continental = ifelse(test = str_detect(string = abstract_data$word, 
                       pattern = continental_terms), 
                       yes = 1, no = 0)) %>%
  dt_mutate(subcontinental = ifelse(test = str_detect(string = abstract_data$word, 
                          pattern = subcontinental_terms), 
                          yes = 1, no = 0)) %>%
  dt_mutate(national = ifelse(test = str_detect(string = abstract_data$word, 
                    pattern = national_terms), 
                    yes = 1, no = 0)) %>%
  dt_mutate(subnational = ifelse(test = str_detect(string = abstract_data$word, 
                       pattern = subnational_terms), 
                       yes = 1, no = 0)) %>%
  dt_mutate(directional = ifelse(test = str_detect(string = abstract_data$word, 
                       pattern = directional_terms), 
                       yes = 1, no = 0)) %>%
  dt_mutate(race_ethnicity = ifelse(test = str_detect(string = abstract_data$word, 
                          pattern = race_ethnicity), 
                          yes = 1, no = 0)) %>%
  dt_mutate(omb_uscensus = ifelse(test = str_detect(string = abstract_data$word, 
                          pattern = omb_uscensus), 
                          yes = 1, no = 0)) %>%
  dt_mutate(ancestry = ifelse(test = str_detect(string = abstract_data$word, 
                          pattern = ancestry), 
                          yes = 1, no = 0))

h2_counts <- pop_terms_bycats %>% 
  filter(all_pop_terms == 1) %>%
  group_by(year) %>% 
  count(all_pop_terms) %>% 
  arrange(year) %>% 
  mutate(term = "all population terms") %>% 
  select(term, n, year) 

h2_counts <- pop_terms_bycats %>% 
  filter(continental == 1) %>%
  group_by(year) %>% 
  count(continental) %>% 
  arrange(year) %>% 
  mutate(term = "continental") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_counts)

h2_counts <- pop_terms_bycats %>% 
  filter(subcontinental == 1) %>%
  group_by(year) %>% 
  count(subcontinental) %>% 
  arrange(year) %>% 
  mutate(term = "subcontinental") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_counts)

h2_counts <- pop_terms_bycats %>% 
  filter(national == 1) %>%
  group_by(year) %>% 
  count(national) %>% 
  arrange(year) %>% 
  mutate(term = "national") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_counts)

h2_counts <- pop_terms_bycats %>% 
  filter(subnational == 1) %>%
  group_by(year) %>% 
  count(subnational) %>% 
  arrange(year) %>% 
  mutate(term = "subnational") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_counts)

h2_counts <- pop_terms_bycats %>% 
  filter(directional == 1) %>%
  group_by(year) %>% 
  count(directional) %>% 
  arrange(year) %>% 
  mutate(term = "directional") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_counts)

h2_counts <- pop_terms_bycats %>% 
  filter(race_ethnicity == 1) %>%
  group_by(year) %>% 
  count(race_ethnicity) %>% 
  arrange(year) %>% 
  mutate(term = "race/ethnicity") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_counts)

h2_counts <- pop_terms_bycats %>% 
  filter(omb_uscensus == 1) %>%
  group_by(year) %>% 
  count(omb_uscensus) %>% 
  arrange(year) %>% 
  mutate(term = "omb/us-census") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_counts)

h2_counts <- pop_terms_bycats %>% 
  filter(ancestry == 1) %>%
  group_by(year) %>% 
  count(ancestry) %>% 
  arrange(year) %>% 
  mutate(term = "ancestry") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_counts)
```

```{r figure 2a, echo=FALSE}
figure_2A <- h2_counts %>%   
  #filter(term != "all population terms") %>% 
  ggplot() + geom_line(aes(y = n, x = year, colour = term), size = 1.3, stat="identity") + 
  theme_minimal() +
  labs(title = "     Figure 2A. Total Growth of Population Terms \n in Biomedical Corpus (1990-2017)",
       color =  "Term") + 
  #scale_linetype_manual( values=linetype) +
  ylab("Term Count") +
  theme(axis.title.x = element_blank(), 
        #axis.title.y = element_blank(), 
        legend.position = "none",
        legend.title = element_text(size = 10, hjust = 0.5, face="bold"),
        plot.title = element_text(size=12, hjust = 0.5)) +
  scale_color_manual(labels=c("all population terms", "ancestry", "continental", 
                              "directional", "national", "omb/us-census", 
                              "race/ethnicity", "subcontinental", "subnational"),
                     values=c("#E21F00","#6b0f6b", "#f2be00", 
                              "#00468b", "#E86F00","#61B329", 
                              "#d23ccc", "#3B9AB2", "#1b7524")) +
  scale_x_continuous(limits = c(1990, 2017),
                     breaks = c(1990, 1995, 2000, 2005, 2010, 2015)); ggplotly() 
```

In Figure 2A, the raw growth trends for the biomedical sample demonstrate that the use of population terminology has grown tremendously over time. In the top red line, we see that when all 8,200+ population terms are combined together into one set, the growth trends increase from just 166 in 1990 to more than 5,000 in 2017. As we can see in the orange and yellow lines, the majority of population terminology is a result of national and continental terms being used more often. While subnational, subcontinental, directional, racial/ethnic, and OMB/US Census terms do rise, these trends never top more than 650 instances in a given year. In fact, the terms in the ancestry set have never surpassed 50 instances per year throughout our sampling period. 

```{r figure 3b, message = FALSE, results = FALSE, echo=FALSE}
# total articles each year 
bycats_prc_counts <- text_data %>% 
  group_by(year) %>% 
  count(year) %>% 
  ungroup() %>% 
  rename(total = n) 

# articles with term mentioned each year 
all_pop_prc_counts <- pop_terms_bycats %>% 
  filter(all_pop_terms == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "all population terms") %>% 
  select(term, n, year)

all_pop_prc_counts <- pop_terms_bycats %>% 
  filter(continental == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "continental") %>% 
  select(term, n, year) %>% 
  bind_rows(all_pop_prc_counts)

all_pop_prc_counts <- pop_terms_bycats %>% 
  filter(subcontinental == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "subcontinental") %>% 
  select(term, n, year) %>% 
  bind_rows(all_pop_prc_counts)

all_pop_prc_counts <- pop_terms_bycats %>% 
  filter(national == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "national") %>% 
  select(term, n, year) %>% 
  bind_rows(all_pop_prc_counts)

all_pop_prc_counts <- pop_terms_bycats %>% 
  filter(subnational == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "subnational") %>% 
  select(term, n, year) %>% 
  bind_rows(all_pop_prc_counts)

all_pop_prc_counts <- pop_terms_bycats %>% 
  filter(directional == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "directional") %>% 
  select(term, n, year) %>% 
  bind_rows(all_pop_prc_counts)

all_pop_prc_counts <- pop_terms_bycats %>% 
  filter(race_ethnicity == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "race/ethnicity") %>% 
  select(term, n, year) %>% 
  bind_rows(all_pop_prc_counts)

all_pop_prc_counts <- pop_terms_bycats %>% 
  filter(omb_uscensus == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "omb/us-census") %>% 
  select(term, n, year) %>% 
  bind_rows(all_pop_prc_counts)

all_pop_prc_counts <- pop_terms_bycats %>% 
  filter(ancestry == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "ancestry") %>% 
  select(term, n, year) %>% 
  bind_rows(all_pop_prc_counts)

all_pop_prc_counts <- all_pop_prc_counts %>% 
  right_join(bycats_prc_counts, by = "year") %>% 
  mutate(percentage = round(n / total * 100, digits = 2))
```

```{r figure_2B, echo=FALSE}
figure_2B <- all_pop_prc_counts %>% 
  ggplot() + 
  geom_line(aes(y = percentage, x = year, colour = term), size = 1.3, stat="identity") +
  labs(title = "    Figure 2B. Proportional Growth of Population Terms \n in Biomedical Corpus (1990-2017)",
       color =  "Term") + 
  theme_minimal() +
  ylab("Proportion of Articles") +
  theme(axis.title.x = element_blank(), 
        legend.box = "vertical", 
        legend.position = "none",
        legend.title = element_text(size = 10, hjust = 0.5, face="bold"),
        plot.title = element_text(size=12, hjust = 0.5)) +
  scale_color_manual(labels=c("all population terms", "ancestry", "continental", 
                              "directional", "national", "omb/us-census", 
                              "race/ethnicity", "subcontinental", "subnational"),
                     values=c("#E21F00","#6b0f6b", "#f2be00", 
                              "#00468b", "#E86F00","#61B329", 
                              "#d23ccc", "#3B9AB2", "#1b7524")) +
  scale_x_continuous(limits = c(1990, 2017),
                     breaks = c(1990, 1995, 2000, 2005, 2010, 2015)); ggplotly()
```

Looking at these trends as proportions, Figure 2B again demonstrates that the overall growth of all population terms (20.06% in 1990 to 30.88% in 2017) is mostly the result of growth in national and continental terms, which increase 9.52% (from 13.06% to 22.58%) and 5.84% (from 7.64% to 13.48%) respectively. On the other hand, the subcontinental, subnational, directional, ancestry, racial/ethnic, and OMB/US Census sets have seen almost no change over time. These results suggests that if the use of population terms is increasing over time, it again is doing so quite modestly and happens mostly through the use of national and continential terms. This is consistent with the Panofsky and Bliss (2017) who, in a much smaller sample of publications from *Nature Genetics*, also find that national and continential terms are becoming the vernacular of choice amoung leading biomedical scholars when conducting population difference testing.

```{r prereqs h2cd, message = FALSE, results = FALSE, warning = FALSE, echo=FALSE}
setwd("~/Documents/Diversity/Data")
# loading the .csv file 
div_text_data <- read_csv("diversity_corpus.csv") %>% 
  drop_na(abstract) %>% 
# filtering 2018 articles because they seem to be incomplete 
  filter(year != "2018") 
# tokenizing the abstract data into words 
abstract_div_data <- div_text_data %>% 
  unnest_tokens(word, abstract) %>% 
  anti_join(stop_words)
# adding custom set of stopwords 
my_stopwords <- tibble(word = c(as.character(1:14), "[0-9]", 
                                "rights", "reserved", "copyright", "elsevier", 
                                "women.recommendations", 
                                "cs.man.ac.uk", "sexes.please", "movements.baby"))
abstract_div_data <- abstract_div_data %>% 
  anti_join(my_stopwords)

# graphing the population terms into various categories 
diversity_bycats <- abstract_div_data %>% 
  as.data.table() %>% 
  dt_mutate(all_pop_terms = ifelse(test = str_detect(string = word, 
                         pattern = all_pop_terms), 
                         yes = 1, no = 0)) %>%
  dt_mutate(continental = ifelse(test = str_detect(string = word, 
                       pattern = continental_terms), 
                       yes = 1, no = 0)) %>%
  dt_mutate(subcontinental = ifelse(test = str_detect(string = word, 
                          pattern = subcontinental_terms), 
                          yes = 1, no = 0)) %>%
  dt_mutate(national = ifelse(test = str_detect(string = word, 
                    pattern = national_terms), 
                    yes = 1, no = 0)) %>%
  dt_mutate(subnational = ifelse(test = str_detect(string = word, 
                       pattern = subnational_terms), 
                       yes = 1, no = 0)) %>%
  dt_mutate(directional = ifelse(test = str_detect(string = word, 
                       pattern = directional_terms), 
                       yes = 1, no = 0)) %>%
  dt_mutate(race_ethnicity = ifelse(test = str_detect(string = word, 
                          pattern = race_ethnicity), 
                          yes = 1, no = 0)) %>%
  dt_mutate(omb_uscensus = ifelse(test = str_detect(string = word, 
                          pattern = omb_uscensus), 
                          yes = 1, no = 0)) %>%
  dt_mutate(ancestry = ifelse(test = str_detect(string = word, 
                          pattern = ancestry), 
                          yes = 1, no = 0))

h2_div_counts <- diversity_bycats %>% 
  filter(all_pop_terms == 1) %>%
  group_by(year) %>% 
  count(all_pop_terms) %>% 
  arrange(year) %>% 
  mutate(term = "all population terms") %>% 
  select(term, n, year) 

h2_div_counts <- diversity_bycats %>% 
  filter(continental == 1) %>%
  group_by(year) %>% 
  count(continental) %>% 
  arrange(year) %>% 
  mutate(term = "continental") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_div_counts)

h2_div_counts <- diversity_bycats %>% 
  filter(subcontinental == 1) %>%
  group_by(year) %>% 
  count(subcontinental) %>% 
  arrange(year) %>% 
  mutate(term = "subcontinental") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_div_counts)

h2_div_counts <- diversity_bycats %>% 
  filter(national == 1) %>%
  group_by(year) %>% 
  count(national) %>% 
  arrange(year) %>% 
  mutate(term = "national") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_div_counts)

h2_div_counts <- diversity_bycats %>% 
  filter(subnational == 1) %>%
  group_by(year) %>% 
  count(subnational) %>% 
  arrange(year) %>% 
  mutate(term = "subnational") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_div_counts)

h2_div_counts <- diversity_bycats %>% 
  filter(directional == 1) %>%
  group_by(year) %>% 
  count(directional) %>% 
  arrange(year) %>% 
  mutate(term = "directional") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_div_counts)

h2_div_counts <- diversity_bycats %>% 
  filter(race_ethnicity == 1) %>%
  group_by(year) %>% 
  count(race_ethnicity) %>% 
  arrange(year) %>% 
  mutate(term = "race/ethnicity") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_div_counts)

h2_div_counts <- diversity_bycats %>% 
  filter(omb_uscensus == 1) %>%
  group_by(year) %>% 
  count(omb_uscensus) %>% 
  arrange(year) %>% 
  mutate(term = "omb/us-census") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_div_counts)

h2_div_counts <- diversity_bycats %>% 
  filter(ancestry == 1) %>%
  group_by(year) %>% 
  count(ancestry) %>% 
  arrange(year) %>% 
  mutate(term = "ancestry") %>% 
  select(term, n, year) %>% 
  bind_rows(h2_div_counts)

```

```{r figure 2c, echo=FALSE}
figure_2C <- h2_div_counts %>%   
  #filter(term != "all population terms") %>% 
  ggplot() + geom_line(aes(y = n, x = year, colour = term), size = 1.3, stat="identity") + 
  theme_minimal() +
  labs(title = "     Figure 2A. Total Growth of Population Terms \n in Diversity Corpus (1990-2017)",
       color =  "Term") + 
  #scale_linetype_manual( values=linetype) +
  ylab("Term Count") +
  theme(axis.title.x = element_blank(), 
        #axis.title.y = element_blank(), 
        legend.position = "none",
        legend.title = element_text(size = 10, hjust = 0.5, face="bold"),
        plot.title = element_text(size=12, hjust = 0.5)) +
  scale_color_manual(labels=c("all population terms", "ancestry", "continental", 
                              "directional", "national", "omb/us-census", 
                              "race/ethnicity", "subcontinental", "subnational"),
                     values=c("#E21F00","#6b0f6b", "#f2be00", 
                              "#00468b", "#E86F00","#61B329", 
                              "#d23ccc", "#3B9AB2", "#1b7524")) +
  scale_x_continuous(limits = c(1990, 2017),
                     breaks = c(1990, 1995, 2000, 2005, 2010, 2015)); ggplotly() 
```

When we replicate these analyses on our diversity sample, Figure 2C again shows that the national and continental terms seem to be driving the majority of the population term usage in our results. In contrast with the biomedical sample, however, the trends show that OMB/US Census and racial/ethnic terms are used more often in the diversity sample.

```{r figure 2d, message = FALSE, results = FALSE, echo=FALSE}
# total articles each year 
div_prc_counts <- div_text_data %>% 
  group_by(year) %>% 
  count(year) %>% 
  ungroup() %>% 
  rename(total = n) 

# articles with term mentioned each year 
div_prc_counts <- diversity_bycats %>% 
  filter(all_pop_terms == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "all population terms") %>% 
  select(term, n, year)

div_prc_counts <- diversity_bycats %>% 
  filter(continental == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "continental") %>% 
  select(term, n, year) %>% 
  bind_rows(div_prc_counts)

div_prc_counts <- diversity_bycats %>% 
  filter(subcontinental == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "subcontinental") %>% 
  select(term, n, year) %>% 
  bind_rows(div_prc_counts)

div_prc_counts <- diversity_bycats %>% 
  filter(national == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "national") %>% 
  select(term, n, year) %>% 
  bind_rows(div_prc_counts)

div_prc_counts <- diversity_bycats %>% 
  filter(subnational == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "subnational") %>% 
  select(term, n, year) %>% 
  bind_rows(div_prc_counts)

div_prc_counts <- diversity_bycats %>% 
  filter(directional == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "directional") %>% 
  select(term, n, year) %>% 
  bind_rows(div_prc_counts)

div_prc_counts <- diversity_bycats %>% 
  filter(race_ethnicity == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "race/ethnicity") %>% 
  select(term, n, year) %>% 
  bind_rows(div_prc_counts)

div_prc_counts <- diversity_bycats %>% 
  filter(omb_uscensus == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "omb/us-census") %>% 
  select(term, n, year) %>% 
  bind_rows(div_prc_counts)

div_prc_counts <- diversity_bycats %>% 
  filter(ancestry == 1) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(pubmed_id)) %>% 
  mutate(term = "ancestry") %>% 
  select(term, n, year) %>% 
  bind_rows(div_prc_counts)

div_prc_counts <- div_prc_counts %>% 
  right_join(bycats_prc_counts, by = "year") %>% 
  mutate(percentage = round(n / total * 100, digits = 2))
```

```{r figure_2D, echo=FALSE}
figure_2D <- div_prc_counts %>% 
  ggplot() + 
  geom_line(aes(y = percentage, x = year, colour = term), size = 1.3, stat="identity") +
  labs(title = "    Figure 2D. Proportional Growth of Population Terms \n in Diversity Corpus (1990-2017)",
       color =  "Term") + 
  theme_minimal() +
  ylab("Proportion of Articles") +
  theme(axis.title.x = element_blank(), 
        legend.box = "vertical", 
        legend.position = "none",
        legend.title = element_text(size = 10, hjust = 0.5, face="bold"),
        plot.title = element_text(size=12, hjust = 0.5)) +
  scale_color_manual(labels=c("all population terms", "ancestry", "continental", 
                              "directional", "national", "omb/us-census", 
                              "race/ethnicity", "subcontinental", "subnational"),
                     values=c("#E21F00","#6b0f6b", "#f2be00", 
                              "#00468b", "#E86F00","#61B329", 
                              "#d23ccc", "#3B9AB2", "#1b7524")) +
  scale_x_continuous(limits = c(1990, 2017),
                     breaks = c(1990, 1995, 2000, 2005, 2010, 2015)); ggplotly()
```

Figure 2D shows that the overall use of population terms is indeed much higher in the diversity sample - occuring in 42.07% of articles compared to just 30.88% of the biomedical sample. This result is not surprising, as our sampling methodology inflates the totals of almost all of the category sets. For example, the OMB/US Census and racial/ethnic totals are nearly 5-6 times greater in this diversity sample. Despite these totals being higher, we do see that the use of population terms are declining from their peak of 60.9% in 1996. While the use of national terms has stayed consistent since the mid-1990's, all of the other term sets have steadily declined since 2003. In the case of the OMB/US Census and race/ethnicity categories, the proportion of abstracts that use these term sets has reduced by nearly half over the past 15 years. 

### Main Takeaway 

At the beginning of this section, we hypothesized that (a) the use of population terminology has increased in biomedical abstracts since 1990 and (b) that the use of terms like genetic ancestry as well as national and continental terms have outpaced racial and ethnic terms in biomedical literature. Our results suggest that population terminology has indeed increased over time within the biomedical sample. However, in the diversity sample, population terminology grew only through the early-1990s before platauing until the mid-2000's and declining thereafter. The majority of growth in these samples has been due to an increase in national and contintental terminology, as most other term sets have either stayed relatively consistent or decreased since the mid-2000's. Thus, while there is strong support for growth in national and continental terms, we find no evidence that the use of genetic ancestry terms have replaced population labels relating to race and ethnicity.

### Appendices 

Here is a list of the 8,200+ terms that were collapsed into the "all population terms" category in these analyses. You can use the search box to find a specific term you are interested in. Please note that this dictionary is still in progress and the sub/categories are both fluid and imperfect. If you have suggestions about what to add and/or reclassify, please send an email to the authors using the email link in the top-right corner.

```{r, warning=FALSE, message=FALSE, echo = FALSE}
setwd("~/Documents/Diversity/Data")
all_pop_terms_table <- read_csv("diversity_project - h2_dictionary.csv")
all_pop_terms_table <- all_pop_terms_table %>% select(-source, -date, -subregional)
all_pop_terms_table[is.na(all_pop_terms_table)] <- ""
DT::datatable(all_pop_terms_table)
```

Here are the counts for top continental terms in the biomedical sample.

```{r, warning=FALSE, message=FALSE, echo = FALSE}
datatable(pop_terms_bycats %>% 
  filter(continental == 1) %>% 
  select(word, continental) %>% 
  count(word, sort = TRUE))
```

Here are the counts for top subcontinental terms in the biomedical sample.

```{r, warning=FALSE, message=FALSE, echo = FALSE}
datatable(pop_terms_bycats %>% 
  filter(subcontinental == 1) %>% 
  select(word, subcontinental) %>% 
  count(word, sort = TRUE))
```

Here are the counts for top national terms in the biomedical sample.

```{r, warning=FALSE, message=FALSE, echo = FALSE}
datatable(pop_terms_bycats %>% 
  filter(national == 1) %>% 
  select(word, national) %>% 
  count(word, sort = TRUE))
```

Here are the counts for top subnational terms in the biomedical sample.

```{r, warning=FALSE, message=FALSE, echo = FALSE}
datatable(pop_terms_bycats %>% 
  filter(subnational == 1) %>% 
  select(word, subnational) %>% 
  count(word, sort = TRUE))
```

Here are examples of how "Chinese" is used in context in the biomedical sample. 

```{r chinese_check, warning=FALSE, message=FALSE, echo = FALSE}
chinese_check <- pop_terms_bycats %>% 
  filter(national == 1) %>% 
  select(pubmed_id, national) %>% 
  group_by(pubmed_id) %>% 
  summarize(national = sum(national)) %>% 
  inner_join(text_data, by = "pubmed_id") %>% 
  select(abstract, national) %>% 
  mutate(abstract = tolower(abstract)) %>% 
  filter(grepl("chinese", abstract))

chinese_check %>% 
  unnest_tokens(bigram, abstract, token = "ngrams", n = 2) %>% 
  count(bigram, sort = TRUE) %>% 
  filter(grepl("chinese", bigram))

```

Here are examples of how "American" is used in context in the biomedical sample. 

```{r american_check, warning=FALSE, message=FALSE, echo = FALSE}
american_check <- pop_terms_bycats %>% 
  filter(national == 1) %>% 
  select(pubmed_id, national) %>% 
  group_by(pubmed_id) %>% 
  summarize(national = sum(national)) %>% 
  inner_join(text_data, by = "pubmed_id") %>% 
  select(abstract, national) %>% 
  mutate(abstract = tolower(abstract)) %>% 
  filter(grepl("american", abstract))

datatable(american_check)

american_check %>% 
  unnest_tokens(bigram, abstract, token = "ngrams", n = 2) %>% 
  count(bigram, sort = TRUE) %>% 
  filter(grepl("american", bigram))
```

Here is the correlation matrix for term sets in the biomedical sample.

```{r, warning=FALSE, message=FALSE, echo = FALSE}
perc_wider <- all_pop_prc_counts %>% 
  select(-n, -total) %>% 
  pivot_wider(names_from = term, values_from = percentage) %>% 
  select(-year)
corr_matrix <- Hmisc::rcorr(as.matrix(perc_wider))
datatable(data.frame(corr_matrix$r) %>% 
  rownames_to_column(var = "terms") %>% 
  rename(all_terms = all.population.terms,
         omb_uscensus = omb.us.census,
         race_ethnicity = race.ethnicity) %>% 
  select(terms, all_terms, national, continental, subnational,  subcontinental,   
         race_ethnicity,omb_uscensus, directional, ancestry) %>% 
  mutate_at(vars(all_terms:ancestry), funs(round(., 3))) %>% 
  arrange(-all_terms))
```

Here is the correlation matrix for term sets in the diversity sample.

```{r, warning=FALSE, message=FALSE, echo = FALSE}
div_perc_wider <- div_prc_counts %>% 
  select(-n, -total) %>% 
  pivot_wider(names_from = term, values_from = percentage) %>% 
  select(-year)
div_corr_matrix <- Hmisc::rcorr(as.matrix(div_perc_wider))
datatable(data.frame(div_corr_matrix$r) %>% 
  rownames_to_column(var = "terms") %>% 
  rename(all_terms = all.population.terms,
         omb_uscensus = omb.us.census,
         race_ethnicity = race.ethnicity) %>% 
  select(terms, all_terms, subnational, omb_uscensus, race_ethnicity,
         continental, national,subcontinental,directional,  ancestry) %>% 
  mutate_at(vars(all_terms:ancestry), funs(round(., 3))) %>% 
  arrange(-all_terms))
```


